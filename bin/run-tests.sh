#!/usr/bin/env bash

# Synopsis:
# Test the test runner by running it against a predefined set of solutions
# with an expected output.

# Output:
# Outputs the diff of the expected test results against the actual test results
# generated by the test runner.

# Example:
# ./bin/run-tests.sh

exit_code=0
test_success_counter=0
test_error_counter=0

# Iterate over all test directories
for test_dir in tests/*; do
    test_dir_name=$(basename "${test_dir}")
    test_dir_path=$(realpath "${test_dir}")
    results_file_path="${test_dir_path}/results.json"
    expected_results_file_path="${test_dir_path}/expected_results.json"

    bin/run.sh "${test_dir_name}" "${test_dir_path}" "${test_dir_path}"

    # Normalize the results file
    sed -i -E \
      -e 's/\([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}\+[0-9]{4}.*?\)//g' \
      -e "s~${test_dir_path}~/solution~g" \
      -e 's/\*load\*(\-[0-9]+)?//g' \
      -e 's/\([0-9]+\.[0-9]+ sec\)//g' \
      -e 's/#<bytecode [^>]*>/#<bytecode >/' \
      "${results_file_path}"

    echo "${test_dir_name}: comparing results.json to expected_results.json"
    diff "${results_file_path}" "${expected_results_file_path}"

    if [ $? -ne 0 ]; then
        echo "${test_dir_name}: ERROR: comparison failed - results.json not matching expected_results.json"
        exit_code=1
        test_error_counter=$[$test_error_counter + 1]
    else
        echo "${test_dir_name}: SUCCESS: results.json is matching expected_results.json"
        test_success_counter=$[$test_success_counter + 1]
    fi
done

if [ "${exit_code}" -eq 0 ]; then
    echo "SUCCESS: All tests passed"
else
    echo "ERROR: ${test_error_counter}/${test_success_counter} tests failed"
fi

exit ${exit_code}
